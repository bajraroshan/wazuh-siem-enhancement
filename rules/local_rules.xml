<!-- 
  Fixed LOLBin Detection Rules for Windows Event Channel
  These rules work with decoded Windows Event 4688 (Process Creation)
  
  Replace your current rules in /var/ossec/etc/rules/local_rules.xml
-->

<group name="local,custom,windows,lolbins">

  <!-- ================= PowerShell LOLBins ================= -->
  
  <!-- PowerShell Encoded Command - TESTED WITH: "commandLine": "powershell.exe -enc ABC123" -->
  <rule id="100500" level="12">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)powershell.*-enc</field>
    <description>PowerShell encoded command detected</description>
    <mitre>
      <id>T1059.001</id>
    </mitre>
    <group>lolbin,powershell,execution</group>
  </rule>

  <rule id="100501" level="12">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)powershell.*EncodedCommand</field>
    <description>PowerShell -EncodedCommand detected</description>
    <mitre>
      <id>T1059.001</id>
    </mitre>
    <group>lolbin,powershell,execution</group>
  </rule>

  <!-- PowerShell Download Cradles -->
  <rule id="100502" level="11">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)DownloadString|DownloadFile|WebClient</field>
    <description>PowerShell download cradle detected</description>
    <mitre>
      <id>T1105</id>
    </mitre>
    <group>lolbin,powershell,download</group>
  </rule>

  <rule id="100503" level="11">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)Invoke-WebRequest|IWR|wget|curl</field>
    <description>PowerShell web request detected</description>
    <mitre>
      <id>T1105</id>
    </mitre>
    <group>lolbin,powershell,download</group>
  </rule>

  <!-- PowerShell Base64 Decoding -->
  <rule id="100504" level="10">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)FromBase64String</field>
    <description>PowerShell base64 decoding detected</description>
    <mitre>
      <id>T1140</id>
    </mitre>
    <group>lolbin,powershell,obfuscation</group>
  </rule>

  <!-- ================= CertUtil LOLBin ================= -->
  
  <rule id="100510" level="11">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)certutil.*-urlcache.*http</field>
    <description>CertUtil download from URL detected</description>
    <mitre>
      <id>T1105</id>
    </mitre>
    <group>lolbin,certutil,download</group>
  </rule>

  <rule id="100511" level="11">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)certutil.*-split.*http</field>
    <description>CertUtil split download detected</description>
    <mitre>
      <id>T1105</id>
    </mitre>
    <group>lolbin,certutil,download</group>
  </rule>

  <rule id="100512" level="11">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)certutil.*-decode</field>
    <description>CertUtil decode operation detected</description>
    <mitre>
      <id>T1140</id>
    </mitre>
    <group>lolbin,certutil,obfuscation</group>
  </rule>

  <!-- ================= BITSAdmin LOLBin ================= -->
  
  <rule id="100520" level="10">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)bitsadmin.*/transfer.*http</field>
    <description>BITSAdmin transfer from URL detected</description>
    <mitre>
      <id>T1197</id>
    </mitre>
    <group>lolbin,bitsadmin,download</group>
  </rule>

  <rule id="100521" level="10">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)bitsadmin.*/download.*http</field>
    <description>BITSAdmin download detected</description>
    <mitre>
      <id>T1197</id>
    </mitre>
    <group>lolbin,bitsadmin,download</group>
  </rule>

  <!-- ================= WMIC LOLBin ================= -->
  
  <rule id="100530" level="11">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)wmic.*process.*call.*create</field>
    <description>WMIC process creation detected</description>
    <mitre>
      <id>T1047</id>
    </mitre>
    <group>lolbin,wmic,execution</group>
  </rule>

  <rule id="100531" level="11">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)wmic.*/node:</field>
    <description>WMIC remote execution detected</description>
    <mitre>
      <id>T1047</id>
    </mitre>
    <group>lolbin,wmic,lateral_movement</group>
  </rule>

  <!-- ================= Rundll32 LOLBin ================= -->
  
  <rule id="100540" level="12">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)rundll32.*javascript:</field>
    <description>Rundll32 JavaScript scheme abuse detected (Squiblydoo)</description>
    <mitre>
      <id>T1218.011</id>
    </mitre>
    <group>lolbin,rundll32,defense_evasion</group>
  </rule>

  <rule id="100541" level="11">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)rundll32.*url\.dll.*FileProtocolHandler</field>
    <description>Rundll32 URL handler abuse detected</description>
    <mitre>
      <id>T1218.011</id>
    </mitre>
    <group>lolbin,rundll32,defense_evasion</group>
  </rule>

  <!-- ================= MSHTA LOLBin ================= -->
  
  <rule id="100550" level="12">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)mshta.*(javascript|vbscript|http)</field>
    <description>MSHTA script execution detected</description>
    <mitre>
      <id>T1218.005</id>
    </mitre>
    <group>lolbin,mshta,defense_evasion</group>
  </rule>

  <!-- ================= Regsvr32 LOLBin ================= -->
  
  <rule id="100560" level="12">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)regsvr32.*/s.*/i:.*\.sct</field>
    <description>Regsvr32 scriptlet abuse detected</description>
    <mitre>
      <id>T1218.010</id>
    </mitre>
    <group>lolbin,regsvr32,defense_evasion</group>
  </rule>

  <rule id="100561" level="11">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)regsvr32.*http</field>
    <description>Regsvr32 remote scriptlet execution detected</description>
    <mitre>
      <id>T1218.010</id>
    </mitre>
    <group>lolbin,regsvr32,defense_evasion</group>
  </rule>

  <!-- ================= MSBuild LOLBin ================= -->
  
  <rule id="100570" level="11">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)msbuild.*\.(xml|csproj|proj)</field>
    <description>MSBuild inline code execution detected</description>
    <mitre>
      <id>T1127.001</id>
    </mitre>
    <group>lolbin,msbuild,execution</group>
  </rule>

  <!-- ================= Other Suspicious Binaries ================= -->
  
  <rule id="100580" level="10">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)cscript.*http</field>
    <description>CScript remote script execution detected</description>
    <mitre>
      <id>T1059.005</id>
    </mitre>
    <group>lolbin,cscript,execution</group>
  </rule>

  <rule id="100581" level="10">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)wscript.*http</field>
    <description>WScript remote script execution detected</description>
    <mitre>
      <id>T1059.005</id>
    </mitre>
    <group>lolbin,wscript,execution</group>
  </rule>

  <!-- ================= Correlation Rules ================= -->
  
  <!-- Multiple LOLBin techniques from same host -->
  <rule id="100600" level="13" frequency="3" timeframe="300">
    <if_matched_group>lolbin</if_matched_group>
    <description>Multiple LOLBin techniques detected in 5 minutes</description>
    <group>lolbin,correlation,ttp</group>
  </rule>

  <!-- PowerShell burst activity -->
  <rule id="100601" level="12" frequency="5" timeframe="120">
    <if_matched_group>powershell</if_matched_group>
    <description>Suspicious PowerShell activity burst</description>
    <group>lolbin,powershell,correlation</group>
  </rule>

  <!-- Download activity burst -->
  <rule id="100602" level="12" frequency="3" timeframe="180">
    <if_matched_group>download</if_matched_group>
    <description>Multiple download attempts detected</description>
    <group>lolbin,download,correlation</group>
  </rule>

</group>
